# 以SM2为例分析缺陷
根据上一个project介绍的SM2算法，下面对于SM2的缺陷进行分析(Schnorr签名类似)
根据PPT上的内容，总共有5个缺陷可以验证:
1. k泄露导致d泄露
2. 对不同的消息使用相同的k签名导致d泄露
3. 两个不同的user使用相同的k,可以相互推测对方的私钥
4. 验证(r,s) and (r,-s)均为合法签名
6. ECDSA与SM2使用相同的d和k而泄露d
## k泄露导致d泄露
![](https://camo.githubusercontent.com/f395d491a8bccfc6f8ade2d61061c3f180a0a3e73bf0b49f6ce380237707b305/68747470733a2f2f7a783737372d313331393533353938352e636f732e61702d6265696a696e672e6d7971636c6f75642e636f6d2f32303233303830313133333130342e706e67)
首先给定一个消息m，使用SM2签名算法对其进行签名，计算得到签名结果(r, s)。 然后通过逆运算，根据公式 (inverse(s + r,n) * (k - s))%n 推导出私钥$d_A$。 最后打印输出私钥$d_A$。

在签名过程中，短暂泄露了签名所使用的随机数k。通过知道签名结果(r, s)，通过简单的逆推运算就可以恢复出私钥sk。这个过程显然是不安全的，因为私钥的泄露会导致签名无效，并且攻击者可以进一步利用私钥进行其他的恶意操作。
## k重用导致d泄露
![](https://camo.githubusercontent.com/0bda4a3f84eb78d6ae20db50c0c55b0ba79e179c373c808f5095527db6a57b1a/68747470733a2f2f7a783737372d313331393533353938352e636f732e61702d6265696a696e672e6d7971636c6f75642e636f6d2f32303233303830313133333735352e706e67)
给定两个不同的消息m1和m2，分别使用SM2签名算法对其进行签名，计算得到签名结果(r1, s1)和(r2, s2)。 然后通过逆运算，根据公式 ((s2 - s1) * inverse((s1 - s2 + r1 - r2),n))%n 推导出私钥$d_A$。 最后打印输出私钥$d_A$。

如果在两个不同的消息上使用相同的随机数k进行签名，那么通过简单的逆推运算，可以推导出私钥$d_A$。这个过程同样是不安全的，因为私钥的重用会导致签名无效，并且攻击者可以通过观察多个签名结果来进一步推导出私钥。

## 多用户重用k

![](https://camo.githubusercontent.com/e7fb0a23fbd1fa15c34d89aadc905cb0375e74954fb4446dc023d1925e8fb4a1/68747470733a2f2f7a783737372d313331393533353938352e636f732e61702d6265696a696e672e6d7971636c6f75642e636f6d2f32303233303830313133343131392e706e67)
给定两个不同的消息m1和m2，分别由两个不同的用户使用SM2签名算法对其进行签名，计算得到签名结果(r1, s1)和(r2, s2)。 然后通过逆运算，根据公式 ((k - s1) * inverse(s1 + r1,n))%n 和 ((k - s2) * inverse(s2 + r2,n))%n 分别推导出用户1和用户2的私钥$d_A$和$d_B$。

如果在不同的用户之间重用相同的随机数k进行签名，那么通过逆推运算，每个用户都能推导出相应的私钥。这种方式同样是不安全的，因为私钥的重用会导致签名无效，并且攻击者可以通过观察不同用户的签名结果来进一步推导出私钥。
## 验证(r,s) and (r,-s)均为合法签名
![](https://img1.imgtp.com/2023/08/03/gP1rLjof.png)
根据上图，如果采用相同的(r,s) and (r,-s)，最终可以验证成功。

## 使用和ECDSA相同的d与k
![](https://camo.githubusercontent.com/81b02006654351be5ae85af577d58380e236b890e2c65ce6a1b0cf6fa2e71cfe/68747470733a2f2f7a783737372d313331393533353938352e636f732e61702d6265696a696e672e6d7971636c6f75642e636f6d2f32303233303830313133343634392e706e67)
给定一个消息m，分别使用SM2签名算法和ECDSA签名算法对其进行签名，计算得到签名结果(r1, s1)和(r2, s2)。 然后通过逆运算，根据公式 ((s1 * s2 - e1) * inverse((r1 - s1 * s2 - s1 * r2),n))%n 推导出私钥sk。

如果使用相同的随机数k和系数d进行签名，通过逆推运算，可以推导出私钥sk。然而，私钥和随机数的重用会破坏密码学的安全性，攻击者可以通过观察多个签名结果来推导出私钥。并且使用相同的随机数k也会导致签名无效。
## 3 运行结果
![](https://img1.imgtp.com/2023/08/03/kNNnUQNy.png)