# 长度扩展攻击

## 1 原理分析
### 1.1 MD结构
MD结构是Ralph Merkle在1979年的博士论文中描述的。因为Ralph Merkle 和 Ivan Damgård 分别证明了这个结构的合理性，所以这个结构被称为Merkle–Damgård结构。

MD结构首先对输入消息进行填充，让消息变成固定长度的整数倍（比如512或者1024）。这是因为压缩算法是不能对任意长度的消息进行处理的，所以在处理之前必须进行填充。通常来说，我们会使用0来填充整个消息块。

流程图如下：

![](https://th.bing.com/th/id/OIP.x6-foi1hWl7EXAVvHF0EbwHaCi?w=301&h=120&c=7&r=0&o=5&dpr=1.5&pid=1.7)

### 1.2 长度扩展攻击

长度扩展攻击是一种针对哈希函数的攻击方式，利用已知哈希值和初始向量构造合法的消息，并生成新的哈希值。

攻击过程如下：
1. 对任意消息r1，首先对其进行填充，得到 m=r1||padding；
2. 调用SM3计算哈希值即 h1=SM3(m,IV)；
3. 自选r2作为进行攻击的消息，计算 h2=SM3(m||r2,IV)即h2=SM3(r1||padding||r2,IV)；
4. 计算 h3=SM3(r2,iv)，其中iv=h1即先前消息的哈希值；
5. 比较h2与h3是否相同，若相同，则攻击成功。

## 2 代码分析
SM3的实现和前面两个project一样，我们只分析不一样的部分。

lengthextension_attack 函数：这个函数执行了长度扩展攻击。它接受三个参数：m 是原始消息，IV 是初始向量，n 是要扩展的长度。函数首先将原始消息 m 的左边填充 '0' 字符，然后进行填充和散列计算，最终返回扩展后的散列值 h。

random_value 列表：这个列表用来存储计算出来的散列值。

生成 h1：使用初始消息 r1 进行填充、块分割并计算散列，然后将散列结果转换为十六进制并存储在 h1 中。生成 h2：将消息 r1 与 r2 相连后进行填充、块分割并计算散列，将散列结果转换为十六进制并存储在 h2 中。

执行长度扩展攻击：使用 lengthextension_attack 函数对 r2 进行长度扩展攻击，传入初始散列值 t 和扩展长度 128。

生成 h3：将长度扩展攻击的散列结果转换为十六进制并存储在 h3 中。

输出结果：打印出原始消息 r1 与 r2 的组合、h2 的值、h3 的值，并检查 h2 和 h3 是否相等，如果相等则输出长度扩展攻击成功的信息。
```
# 
def lengthextension_attack(m, IV, n):
    for i in range(n):
        m = '0' + m
    M = padding(m)
    M1 = block(M)
    h = SM3(M1, IV)
    return h
```
## 3 运行结果
原始信息为：12345678
附加信息为：87654321
![](https://img1.imgtp.com/2023/08/02/LGZoKhlN.png)